# ============================================================================
# MCP Dock ç¤¾åŒºè´¡çŒ® PR è‡ªåŠ¨æ ¡éªŒ
# ============================================================================
# è§¦å‘æ¡ä»¶ï¼šPR æäº¤åˆ° community-registry/** ç›®å½•
# åŠŸèƒ½ï¼šä½¿ç”¨ ajv-cli æ ¡éªŒæäº¤çš„ JSON æ–‡ä»¶æ˜¯å¦ç¬¦åˆ Schema è§„èŒƒ
# ============================================================================

name: Validate Community PR

on:
  pull_request:
    paths:
      - 'community-registry/**/*.json'
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate JSON Schema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv-cli
        run: npm install -g ajv-cli ajv-formats

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            community-registry/**/*.json

      - name: Validate Server JSON files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ” Validating changed JSON files..."
          
          ERRORS=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "ğŸ“„ Checking: $file"
            
            # æ ¹æ®ç›®å½•é€‰æ‹©å¯¹åº”çš„ Schema
            if [[ "$file" == community-registry/servers/* ]]; then
              SCHEMA="schemas/server.schema.json"
              TYPE="Server"
            elif [[ "$file" == community-registry/skills/* ]]; then
              SCHEMA="schemas/skill.schema.json"
              TYPE="Skill"
            else
              echo "  âš ï¸  Skipping: Unknown directory"
              continue
            fi
            
            # è·³è¿‡æ¨¡æ¿æ–‡ä»¶
            if [[ "$file" == *"_template.json" ]]; then
              echo "  â„¹ï¸  Skipping template file"
              continue
            fi
            
            # æ ¡éªŒ JSON æ ¼å¼
            if ! python3 -c "import json; json.load(open('$file'))"; then
              echo "  âŒ Invalid JSON syntax"
              ERRORS=$((ERRORS + 1))
              continue
            fi
            
            # ä½¿ç”¨ ajv-cli æ ¡éªŒ Schema
            if ajv validate -s "$SCHEMA" -d "$file" --spec=draft2019 --all-errors; then
              echo "  âœ… Valid $TYPE definition"
            else
              echo "  âŒ Schema validation failed"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            echo ""
            echo "ğŸ“š Please ensure your JSON files conform to the schema:"
            echo "   - Servers: schemas/server.schema.json"
            echo "   - Skills: schemas/skill.schema.json"
            echo ""
            echo "ğŸ’¡ Tips:"
            echo "   - Use the _template.json files as a starting point"
            echo "   - Run 'npx mcp-publisher init' for servers"
            exit 1
          fi
          
          echo ""
          echo "âœ… All validations passed!"

      - name: Comment on PR (Success)
        if: success() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Schema Validation Passed**\n\nAll submitted JSON files conform to the MCP Dock schema specification. Thank you for your contribution!'
            })

      - name: Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Schema Validation Failed**\n\nPlease check the workflow logs for details and ensure your JSON files conform to the schema specification.\n\nğŸ“š Reference:\n- [Server Schema](./schemas/server.schema.json)\n- [Skill Schema](./schemas/skill.schema.json)\n\nğŸ’¡ Use the `_template.json` files as a starting point.'
            })
